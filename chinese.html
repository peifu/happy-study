<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>快乐学习 - 小学语文诗词</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #ea4335;
            --secondary: #fbbc05;
            --accent: #ff6b6b;
            --success: #4caf50;
            --warning: #ff9800;
            --info: #4285f4;
            --dark: #0a1929;
            --darker: #051321;
            --card-bg: rgba(15, 35, 55, 0.7);
            --text: #ffffff;
            --text-secondary: #a0aec0;
            --transition: all 0.3s ease;
            --bg-color: #0a1929;
            --text-color: #ffffff;
            --card-bg-color: rgba(15, 35, 55, 0.7);
            --font-size: 16px;
        }
      
        .light-theme {
            --bg-color: #f0f2f5;
            --text-color: #222;
            --card-bg-color: rgba(255, 255, 255, 0.95);
            --primary: #0078d4;
            --secondary: #00bfae;
            --accent: #ff6b6b;
            --success: #43a047;
            --warning: #ff9800;
            --info: #1976d2;
            --dark: #f5f7fa;
            --darker: #e3e8ef;
            --text-secondary: #6b7280;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft YaHei', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, var(--darker), var(--dark));
            color: var(--text);
            min-height: 100vh;
            line-height: 1.6;
            overflow-x: hidden;
            background-color: var(--bg-color);
            color: var(--text-color);
            font-size: var(--font-size);
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* 导航样式 */
        .nav-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            border-bottom: 1px solid rgba(234, 67, 53, 0.3);
            margin-bottom: 30px;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 28px;
            font-weight: 700;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 10px rgba(234, 67, 53, 0.5);
            cursor: pointer;
        }
        
        .nav-links {
            display: flex;
            gap: 25px;
        }
        
        .nav-link {
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }
        
        .nav-link::before {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 0;
            height: 2px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            transition: var(--transition);
        }
        
        .nav-link:hover::before {
            width: 100%;
        }
        
        .nav-link.active {
            background: rgba(234, 67, 53, 0.1);
        }
        
        .nav-link.active::before {
            width: 100%;
        }
        
        /* 页面内容 */
        .page {
            display: none;
            animation: fadeIn 0.5s ease;
        }
        
        .page.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* 主页样式 */
        .main-content {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 30px;
        }
        
        .poem-card {
            background: var(--card-bg-color);
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            position: relative;
            overflow: hidden;
            min-height: 400px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border: 1px solid rgba(234, 67, 53, 0.2);
            text-align: center;
        }
        
        .poem-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
        }
        
        .poem-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(234, 67, 53, 0.1) 0%, transparent 70%);
            transform: rotate(30deg);
            z-index: 0;
        }
        
        .title-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 15px;
            position: relative;
            z-index: 1;
        }
        
        .poem-title {
            font-size: 32px;
            font-weight: 700;
            color: var(--primary);
            text-shadow: 0 0 10px rgba(234, 67, 53, 0.3);
        }
        
        .read-btn {
            background: rgba(234, 67, 53, 0.2);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
            color: var(--primary);
        }
        
        .read-btn:hover {
            background: rgba(234, 67, 53, 0.3);
            transform: scale(1.1);
        }
        
        .poem-author {
            font-size: 18px;
            color: var(--text-secondary);
            margin-bottom: 30px;
            position: relative;
            z-index: 1;
            font-style: italic;
        }
        
        .poem-content {
            font-size: 24px;
            line-height: 1.8;
            margin-bottom: 30px;
            position: relative;
            z-index: 1;
        }
        
        .poem-line {
            margin-bottom: 15px;
            display: block;
        }
        
        .poem-translation {
            font-style: italic;
            color: var(--text-secondary);
            text-align: center;
            margin-bottom: 30px;
            position: relative;
            z-index: 1;
            border-left: 3px solid var(--secondary);
            padding-left: 15px;
            font-size: 18px;
        }
        
        .card-controls {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            position: relative;
            z-index: 1;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: linear-gradient(90deg, var(--primary), var(--info));
            color: white;
        }
        
        .btn-primary:hover {
            box-shadow: 0 0 15px rgba(234, 67, 53, 0.5);
            transform: translateY(-2px);
        }
        
        .btn-success {
            background: linear-gradient(90deg, var(--success), var(--secondary));
            color: white;
        }
        
        .btn-success:hover {
            box-shadow: 0 0 15px rgba(76, 175, 80, 0.5);
            transform: translateY(-2px);
        }
        
        .btn-warning {
            background: linear-gradient(90deg, var(--warning), var(--accent));
            color: white;
        }
        
        .btn-warning:hover {
            box-shadow: 0 0 15px rgba(255, 152, 0, 0.5);
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background: transparent;
            color: var(--text-color);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .btn-secondary:hover {
            border-color: var(--primary);
            box-shadow: 0 0 15px rgba(234, 67, 53, 0.3);
        }
        
        /* 进度容器 */
        .progress-container {
            background: var(--card-bg-color);
            border-radius: 16px;
            padding: 25px;
            border: 1px solid rgba(234, 67, 53, 0.2);
        }
        
        .progress-title {
            font-size: 20px;
            margin-bottom: 20px;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .stats {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .stat-card {
            background: rgba(0, 0, 0, 0.1);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--secondary);
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 14px;
            color: var(--text-secondary);
        }
        
        .progress-bar-container {
            margin: 20px 0;
        }
        
        .progress-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            color: var(--text-secondary);
            font-size: 14px;
        }
        
        .progress-bar {
            height: 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            border-radius: 10px;
            width: 0%;
            box-shadow: 0 0 10px rgba(234, 67, 53, 0.3);
            transition: width 0.5s ease;
        }
        
        /* 诗词选集 */
        .poem-selector {
            margin-top: 20px;
        }
        
        .poem-list {
            max-height: 300px;
            overflow-y: auto;
            margin-top: 15px;
        }
        
        .poem-item {
            padding: 12px 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .poem-item:hover {
            background: rgba(234, 67, 53, 0.1);
        }
        
        .poem-item.mastered {
            border-left: 4px solid var(--secondary);
        }
        
        .poem-item .poem-name {
            font-weight: 600;
        }
        
        .poem-item .poem-author {
            font-size: 14px;
            color: var(--text-secondary);
            margin: 0;
        }
        
        .poem-item-status {
            display: flex;
            justify-content: flex-end;
        }
        
        .status-badge {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            background: rgba(251, 188, 5, 0.2);
            color: var(--secondary);
        }
        
        /* 设置页面样式 */
        .settings-container {
            background: var(--card-bg-color);
            border-radius: 16px;
            padding: 25px;
            border: 1px solid rgba(234, 67, 53, 0.2);
            max-width: 600px;
            margin: 0 auto;
        }
        
        .setting-group {
            margin-bottom: 25px;
        }
        
        .setting-title {
            font-size: 20px;
            margin-bottom: 15px;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .setting-options {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
        }
        
        .setting-option {
            padding: 12px;
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: var(--transition);
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .setting-option:hover {
            background: rgba(234, 67, 53, 0.1);
        }
        
        .setting-option.active {
            background: rgba(234, 67, 53, 0.2);
            border-color: var(--primary);
        }

        /* 设置页面样式 */
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-top: 20px;
        }

        .settings-card {
            background: var(--card-bg-color);
            border-radius: 16px;
            padding: 25px;
            /* border-color 改为与页面主色协调的红色半透明 */
            border: 1px solid rgba(234, 67, 53, 0.15);
            transition: var(--transition);
        }

        .settings-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        .settings-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            color: var(--primary);
            font-size: 22px;
            font-weight: 600;
        }

        .settings-icon {
            font-size: 24px;
            width: 30px;
            text-align: center;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-secondary);
        }

        .form-control {
            width: 100%;
            background: rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--text-color);
            padding: 12px 15px;
            border-radius: 8px;
            transition: var(--transition);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 15px rgba(234, 67, 53, 0.25);
        }


        /* 下拉选项样式 - 提高可读性 */
        .form-control option {
            background: var(--card-bg-color);
            color: var(--text-color);
            padding: 8px 12px;
        }

        /* 下拉选项悬停效果 */
        .form-control option:hover,
        .form-control option:focus,
        .form-control option:checked {
            background: var(--primary);
            color: white;
        }

        .range-slider {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: var(--progress-bg);
            outline: none;
            margin: 10px 0;
        }

        .range-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--primary);
            cursor: pointer;
            /* 使用红色光晕代替之前的青色 */
            box-shadow: 0 0 10px rgba(234, 67, 53, 0.3);
        }

        .slider-value {
            text-align: center;
            font-size: 18px;
            color: var(--primary);
            margin-top: 10px;
        }

        /* 响应式设计 */
        @media (max-width: 900px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .nav-container {
                flex-direction: column;
                gap: 20px;
            }
            
            .stats {
                grid-template-columns: 1fr 1fr;
            }
        }
        
        @media (max-width: 600px) {
            .stats {
                grid-template-columns: 1fr;
            }
            
            .nav-links {
                flex-direction: column;
                gap: 10px;
            }
            
            .card-controls {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
            
            .poem-content {
                font-size: 20px;
            }
            
            .poem-title {
                font-size: 26px;
            }
            
            .title-container {
                flex-direction: column;
                gap: 10px;
            }
            
            .setting-options {
                grid-template-columns: 1fr;
            }
        }
        
        /* 动画效果 */
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(234, 67, 53, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(234, 67, 53, 0); }
            100% { box-shadow: 0 0 0 0 rgba(234, 67, 53, 0); }
        }
        
        .pulse {
            animation: pulse 2s infinite;
        }
        
        footer {
            text-align: center;
            margin-top: 50px;
            padding: 20px;
            color: var(--text-secondary);
            font-size: 14px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: var(--text-secondary);
        }
        
        .error-message {
            text-align: center;
            padding: 10px;
            color: var(--primary);
            background: rgba(234, 67, 53, 0.1);
            border-radius: 8px;
            margin-top: 10px;
        }
    </style>
    <script src="common.js"></script>
</head>
<body>
    <div class="container">
        <div class="nav-container">
            <div class="logo" id="homeLink">
                <i class="fas fa-brain"></i>
                <span>快乐学习</span>
            </div>
            
            <div class="nav-links">
                <div class="nav-link active" data-page="chinese">
                    <i class="fas fa-pen-fancy"></i>
                    <span>语文诗词</span>
                </div>
                <div class="nav-link" data-page="daily">
                    <i class="fas fa-calendar-day"></i>
                    <span>日积月累</span>
                </div>
                <div class="nav-link" data-page="settings">
                    <i class="fas fa-cog"></i>
                    <span>设置</span>
                </div>
            </div>
        </div>
        
        <!-- 语文诗词页面 -->
        <div class="page active" id="chinesePage">
            <div class="main-content">
                <div class="poem-card">
                    <div class="title-container">
                        <h2 class="poem-title" id="poemTitle">静夜思</h2>
                        <button class="read-btn" id="readBtn" title="朗读诗词">
                            <i class="fas fa-volume-up"></i>
                        </button>
                    </div>
                    <div class="poem-author" id="poemAuthor">【唐】李白</div>
                    
                    <div class="poem-content" id="poemContent">
                        <span class="poem-line">床前明月光，</span>
                        <span class="poem-line">疑是地上霜。</span>
                        <span class="poem-line">举头望明月，</span>
                        <span class="poem-line">低头思故乡。</span>
                    </div>
                    
                    <div class="poem-translation" id="poemTranslation">
                        明亮的月光洒在窗户纸上，好像地上泛起了一层霜。我禁不住抬起头来，看那天窗外空中的一轮明月，不由得低头沉思，想起远方的家乡。
                    </div>
                    
                    <div class="card-controls">
                        <button class="btn btn-primary" id="prevBtn">
                            <i class="fas fa-arrow-left"></i>
                            <span>上一首</span>
                        </button>
                        <button class="btn btn-success" id="knowBtn">
                            <i class="fas fa-check"></i>
                            <span>已背诵</span>
                        </button>
                        <button class="btn btn-warning" id="notKnowBtn">
                            <i class="fas fa-times"></i>
                            <span>未掌握</span>
                        </button>
                        <button class="btn btn-primary" id="nextBtn">
                            <span>下一首</span>
                            <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                </div>
                
                <div class="progress-container">
                    <div class="progress-title">
                        <i class="fas fa-chart-line"></i>
                        <span>学习进度</span>
                    </div>
                    
                    <div class="stats">
                        <div class="stat-card">
                            <div class="stat-value" id="totalCount">36</div>
                            <div class="stat-label">诗词总数</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="learnedCount">12</div>
                            <div class="stat-label">已学诗词</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="masteredCount">8</div>
                            <div class="stat-label">已背诵</div>
                        </div>
                    </div>
                    
                    <div class="progress-bar-container">
                        <div class="progress-info">
                            <span>背诵进度</span>
                            <span id="progressPercentage">33%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill" style="width: 33%"></div>
                        </div>
                    </div>
                    
                    <div class="progress-title">
                        <i class="fas fa-book"></i>
                        <span>诗词选集</span>
                    </div>
                    
                    <select class="form-control" id="bookSelector">
                        <option value="grade1">小学一年级</option>
                        <option value="grade2">小学二年级</option>
                        <option value="grade3">小学三年级</option>
                        <option value="grade4">小学四年级</option>
                        <option value="grade5">小学五年级</option>
                        <option value="grade6">小学六年级</option>
                    </select>
                    
                    <div class="poem-list" id="poemList">
                        <div class="loading">
                            <i class="fas fa-spinner fa-spin"></i>
                            <span>加载诗词列表中...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 日积月累页面 -->
        <div class="page" id="dailyPage">
            <div class="poem-card">
                <h2 class="poem-title">日积月累</h2>
                <div class="poem-author">知识在于积累</div>
                
                <div class="poem-content">
                    <span class="poem-line">读书破万卷，下笔如有神。</span>
                    <span class="poem-line">——杜甫</span>
                </div>
                
                <div class="poem-translation">
                    形容博览群书，把书读透，这样落实到笔下，运用起来就会得心应手。
                </div>
                
                <div class="card-controls">
                    <button class="btn btn-primary">
                        <i class="fas fa-random"></i>
                        <span>随机一条</span>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- 设置页面 -->
        <div class="page" id="settingsPage">
            <h2>系统设置</h2>
            <div class="settings-grid">
                <div class="settings-card">
                    <div class="settings-header">
                        <i class="fas fa-volume-up settings-icon"></i>
                        <div class="settings-title">发音设置</div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">发音速度</label>
                        <input type="range" min="0.5" max="1.5" step="0.1" value="1.0" class="range-slider"
                            id="speechRateSlider">
                        <div class="slider-value" id="speechRateValue">1.0</div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">发音音调</label>
                        <input type="range" min="0.5" max="2.0" step="0.1" value="1.0" class="range-slider"
                            id="speechPitchSlider">
                        <div class="slider-value" id="speechPitchValue">1.0</div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">发音人</label>
                        <select class="form-control" id="voiceSelect">
                            <option value="">默认发音人</option>
                        </select>
                        <!-- 新增：测试发音按钮 -->
                        <div style="margin-top:10px;">
                            <button id="voiceTestBtn" class="btn btn-primary" type="button" style="width: 100%; margin-bottom: 15px;">
                                <i class="fas fa-microphone"></i>
                                <span>测试发音</span>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="settings-card">
                    <div class="settings-header">
                        <i class="fas fa-database settings-icon"></i>
                        <div class="settings-title">数据管理</div>
                    </div>

                    <div class="form-group">
                        <button class="btn btn-primary" style="width: 100%; margin-bottom: 15px;">
                            <i class="fas fa-download"></i>
                            <span>导出学习数据</span>
                        </button>

                        <button class="btn btn-secondary" style="width: 100%; margin-bottom: 15px;">
                            <i class="fas fa-upload"></i>
                            <span>导入学习数据</span>
                        </button>

                        <button class="btn btn-warning" style="width: 100%;">
                            <i class="fas fa-trash"></i>
                            <span>重置学习进度</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <footer>
            <p>© 2025 快乐学习 - Sevenking Studio</p>
        </footer>
    </div>

    <script>
        // 默认诗词数据（当JSON加载失败时使用）
        const defaultPoemsData = {
            grade1: [
                {
                    title: "静夜思",
                    author: "【唐】李白",
                    content: ["床前明月光，", "疑是地上霜。", "举头望明月，", "低头思故乡。"],
                    translation: "明亮的月光洒在窗户纸上，好像地上泛起了一层霜。我禁不住抬起头来，看那天窗外空中的一轮明月，不由得低头沉思，想起远方的家乡。"
                },
                {
                    title: "春晓",
                    author: "【唐】孟浩然",
                    content: ["春眠不觉晓，", "处处闻啼鸟。", "夜来风雨声，", "花落知多少。"],
                    translation: "春日里贪睡不知不觉天就亮了，到处可以听见小鸟的鸣叫声。回想昨夜的阵阵风雨声，不知吹落了多少娇美的春花。"
                },
                {
                    title: "悯农",
                    author: "【唐】李绅",
                    content: ["锄禾日当午，", "汗滴禾下土。", "谁知盘中餐，", "粒粒皆辛苦。"],
                    translation: "盛夏中午，烈日炎炎，农民还在劳作，汗珠滴入泥土。有谁想到，我们碗中的米饭，一粒一粒都是农民辛苦劳动得来的呀？"
                }
            ],
            grade2: [
                {
                    title: "登鹳雀楼",
                    author: "【唐】王之涣",
                    content: ["白日依山尽，", "黄河入海流。", "欲穷千里目，", "更上一层楼。"],
                    translation: "夕阳依傍着西山慢慢地沉没，滔滔黄河朝着东海汹涌奔流。若想把千里的风光景物看够，那就要登上更高的一层城楼。"
                },
                {
                    title: "望庐山瀑布",
                    author: "【唐】李白",
                    content: ["日照香炉生紫烟，", "遥看瀑布挂前川。", "飞流直下三千尺，", "疑是银河落九天。"],
                    translation: "香炉峰在阳光的照射下生起紫色烟霞，从远处看去瀑布好似白色绢绸悬挂山前。高崖上飞腾直落的瀑布好像有几千尺，让人怀疑是银河从天上泻落到人间。"
                }
            ]
        };

        let poemsData = {};
        let currentBook = 'grade1';
        let currentPoemIndex = 0;
        let learnedPoems = {};
        let masteredPoems = {};
        let voiceType = '普通话';
        let currentTheme = 'dark';
        let currentFontSize = 'medium';

        // DOM元素
        const poemTitleElement = document.getElementById('poemTitle');
        const poemAuthorElement = document.getElementById('poemAuthor');
        const poemContentElement = document.getElementById('poemContent');
        const poemTranslationElement = document.getElementById('poemTranslation');
        const bookSelectorElement = document.getElementById('bookSelector');
        const readBtnElement = document.getElementById('readBtn');
        const knowBtnElement = document.getElementById('knowBtn');
        const notKnowBtnElement = document.getElementById('notKnowBtn');
        const nextBtnElement = document.getElementById('nextBtn');
        const prevBtnElement = document.getElementById('prevBtn');
        const totalCountElement = document.getElementById('totalCount');
        const learnedCountElement = document.getElementById('learnedCount');
        const masteredCountElement = document.getElementById('masteredCount');
        const progressFillElement = document.getElementById('progressFill');
        const progressPercentageElement = document.getElementById('progressPercentage');
        const poemListElement = document.getElementById('poemList');
        const navLinks = document.querySelectorAll('.nav-link');
        const pages = document.querySelectorAll('.page');
        const saveSettingsBtn = document.getElementById('saveSettings');
        const resetSettingsBtn = document.getElementById('resetSettings');
        const homeLink = document.getElementById('homeLink');

        // 初始化
        function init() {
            syncThemeFromIndex();
            // 加载学习进度
            loadProgress();
            
            // 加载设置
            loadSettings();
            
            // 加载诗词数据
            loadPoemsData();
            
            // 设置事件监听
            setupEventListeners();
        }

        function syncThemeFromIndex() {
            function applyTheme(theme) {
                if (theme === 'light') {
                    document.body.classList.add('light-theme');
                } else if (theme === 'dark') {
                    document.body.classList.remove('light-theme');
                } else if (theme === 'auto') {
                    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                    if (prefersDark) {
                        document.body.classList.remove('light-theme');
                    } else {
                        document.body.classList.add('light-theme');
                    }
                }
            }
            const theme = localStorage.getItem('theme') || 'dark';
            applyTheme(theme);
            // 监听系统主题变化
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
                if ((localStorage.getItem('theme') || 'dark') === 'auto') {
                    applyTheme('auto');
                }
            });
        }

        // 加载诗词数据
        function loadPoemsData() {
            // 模拟从JSON文件加载数据
            fetch('chinese-poems.json')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('网络响应不正常');
                    }
                    return response.json();
                })
                .then(data => {
                    poemsData = data;
                    updateUI();
                })
                .catch(error => {
                    console.error('加载诗词数据失败，使用默认数据:', error);
                    poemsData = defaultPoemsData;
                    showError('加载远程数据失败，使用默认诗词数据');
                    updateUI();
                });
        }

        // 显示错误信息
        function showError(message) {
            const errorElement = document.createElement('div');
            errorElement.className = 'error-message';
            errorElement.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${message}`;
            poemListElement.innerHTML = '';
            poemListElement.appendChild(errorElement);
            
            // 3秒后消失
            setTimeout(() => {
                errorElement.style.opacity = '0';
                setTimeout(() => {
                    if (poemListElement.contains(errorElement)) {
                        poemListElement.removeChild(errorElement);
                    }
                }, 1000);
            }, 3000);
        }

        // 更新UI
        function updateUI() {
            showCurrentPoem();
            updateProgress();
            updatePoemList();
            applyTheme();
            applyFontSize();
        }

        // 设置事件监听
        function setupEventListeners() {
            // 使用公共导航事件绑定
            setupNavLinks(navLinks, pages);

            // 诗词本选择
            bookSelectorElement.addEventListener('change', handleBookChange);
            
            // 控制按钮
            readBtnElement.addEventListener('click', readCurrentPoem);
            knowBtnElement.addEventListener('click', markAsMemorized);
            notKnowBtnElement.addEventListener('click', markAsNotMemorized);
            nextBtnElement.addEventListener('click', showNextPoem);
            prevBtnElement.addEventListener('click', showPrevPoem);
            
            // 设置选项
            document.querySelectorAll('.setting-option').forEach(option => {
                option.addEventListener('click', handleSettingOptionClick);
            });
            
            // 保存和重置设置（有可能页面没有这些按钮，先判断）
            if (typeof saveSettingsBtn !== 'undefined' && saveSettingsBtn) {
                saveSettingsBtn.addEventListener('click', saveSettings);
            }
            if (typeof resetSettingsBtn !== 'undefined' && resetSettingsBtn) {
                resetSettingsBtn.addEventListener('click', resetSettings);
            }

            // 主页链接
            setupHomeLink('homeLink', 'index.html');
        
            // 绑定发音人选择保存与测试按钮（如存在）
            const voiceSelectEl = document.getElementById('voiceSelect');
            if (voiceSelectEl) {
                voiceSelectEl.addEventListener('change', () => {
                    localStorage.setItem('selectedVoiceZh', voiceSelectEl.value);
                });
            }
            const voiceTestBtn = document.getElementById('voiceTestBtn');
            if (voiceTestBtn) {
                voiceTestBtn.addEventListener('click', testVoice);
            }

            // 语速 / 音调滑块：更新显示并立即保存
            const rateEl = document.getElementById('speechRateSlider');
            const rateVal = document.getElementById('speechRateValue');
            if (rateEl && rateVal) {
                // initialize display
                rateVal.textContent = rateEl.value;
                rateEl.addEventListener('input', () => {
                    rateVal.textContent = rateEl.value;
                    localStorage.setItem('speechRateZh', rateEl.value);
                });
            }
            const pitchEl = document.getElementById('speechPitchSlider');
            const pitchVal = document.getElementById('speechPitchValue');
            if (pitchEl && pitchVal) {
                // initialize display
                pitchVal.textContent = pitchEl.value;
                pitchEl.addEventListener('input', () => {
                    pitchVal.textContent = pitchEl.value;
                    localStorage.setItem('speechPitchZh', pitchEl.value);
                });
            }

            // 绑定完毕后无需返回，其他绑定（如保存/重置）仍按存在与否工作
        }

        // 处理设置选项点击
        function handleSettingOptionClick(e) {
            const option = e.currentTarget;
            const group = option.parentElement;
            const options = group.querySelectorAll('.setting-option');
            
            options.forEach(opt => opt.classList.remove('active'));
            option.classList.add('active');
            
            // 根据选项类型更新设置
            if (group.parentElement.querySelector('.setting-title').textContent.includes('语音')) {
                voiceType = option.getAttribute('data-voice');
            } else if (group.parentElement.querySelector('.setting-title').textContent.includes('主题')) {
                currentTheme = option.getAttribute('data-theme');
            } else if (group.parentElement.querySelector('.setting-title').textContent.includes('字体')) {
                currentFontSize = option.getAttribute('data-fontsize');
            }
        }

        // 保存设置
        function saveSettings() {
            localStorage.setItem('voiceTypeZh', voiceType);
            localStorage.setItem('theme', currentTheme);
            localStorage.setItem('fontSize', currentFontSize);

            // persist speech sliders and selected voice
            const rateEl = document.getElementById('speechRateSlider');
            const pitchEl = document.getElementById('speechPitchSlider');
            const voiceSelect = document.getElementById('voiceSelect');
            if (rateEl) localStorage.setItem('speechRateZh', rateEl.value);
            if (pitchEl) localStorage.setItem('speechPitchZh', pitchEl.value);
            if (voiceSelect && voiceSelect.value) localStorage.setItem('selectedVoiceZh', voiceSelect.value);

            applyTheme();
            applyFontSize();

            // 显示保存成功提示
            alert('设置已保存！');
        }

        // 重置设置
        function resetSettings() {
            voiceType = '普通话';
            currentTheme = 'dark';
            currentFontSize = 'medium';
            
            // 更新UI
            document.querySelectorAll('.setting-option').forEach(option => {
                option.classList.remove('active');
                
                if (option.getAttribute('data-voice') === voiceType) {
                    option.classList.add('active');
                }
                if (option.getAttribute('data-theme') === currentTheme) {
                    option.classList.add('active');
                }
                if (option.getAttribute('data-fontsize') === currentFontSize) {
                    option.classList.add('active');
                }
            });
            
            applyTheme();
            applyFontSize();
            
            // 显示重置成功提示
            alert('设置已重置为默认值！');
        }

        // 应用主题
        function applyTheme() {
            if (currentTheme === 'dark') {
                document.documentElement.style.setProperty('--bg-color', '#0a1929');
                document.documentElement.style.setProperty('--text-color', '#ffffff');
                document.documentElement.style.setProperty('--card-bg-color', 'rgba(15, 35, 55, 0.7)');
            } else if (currentTheme === 'light') {
                document.documentElement.style.setProperty('--bg-color', '#f0f2f5');
                document.documentElement.style.setProperty('--text-color', '#333333');
                document.documentElement.style.setProperty('--card-bg-color', 'rgba(255, 255, 255, 0.9)');
            } else if (currentTheme === 'blue') {
                document.documentElement.style.setProperty('--bg-color', '#0a2f5e');
                document.documentElement.style.setProperty('--text-color', '#ffffff');
                document.documentElement.style.setProperty('--card-bg-color', 'rgba(25, 55, 109, 0.7)');
            }
        }

        // 应用字体大小
        function applyFontSize() {
            if (currentFontSize === 'small') {
                document.documentElement.style.setProperty('--font-size', '14px');
            } else if (currentFontSize === 'medium') {
                document.documentElement.style.setProperty('--font-size', '16px');
            } else if (currentFontSize === 'large') {
                document.documentElement.style.setProperty('--font-size', '18px');
            }
        }

        // 加载设置
        function loadSettings() {
            const savedVoiceType = localStorage.getItem('voiceTypeZh');
            const savedTheme = localStorage.getItem('theme');
            const savedFontSize = localStorage.getItem('fontSize');
            const savedRate = localStorage.getItem('speechRateZh');
            const savedPitch = localStorage.getItem('speechPitchZh');
            const savedVoiceName = localStorage.getItem('selectedVoiceZh');

            if (savedVoiceType) voiceType = savedVoiceType;
            if (savedTheme) currentTheme = savedTheme;
            if (savedFontSize) currentFontSize = savedFontSize;

            // 如果保存了速率/音调，先恢复到控件（voices 可能尚未加载，但 sliders 独立）
            if (savedRate && document.getElementById('speechRateSlider')) {
                document.getElementById('speechRateSlider').value = savedRate;
                const rv = document.getElementById('speechRateValue');
                if (rv) rv.textContent = savedRate;
            }
            if (savedPitch && document.getElementById('speechPitchSlider')) {
                document.getElementById('speechPitchSlider').value = savedPitch;
                const pv = document.getElementById('speechPitchValue');
                if (pv) pv.textContent = savedPitch;
            }

            // 更新设置UI（保留原有视觉化选项）
            document.querySelectorAll('.setting-option').forEach(option => {
                if (option.getAttribute('data-voice') === voiceType) {
                    option.classList.add('active');
                }
                if (option.getAttribute('data-theme') === currentTheme) {
                    option.classList.add('active');
                }
                if (option.getAttribute('data-fontsize') === currentFontSize) {
                    option.classList.add('active');
                }
            });

            // 填充发音人选项（populateVoiceList 会根据 localStorage.selectedVoiceZh 恢复选择）
            populateVoiceList();
        }

        // 填充发音人选项
        function populateVoiceList() {
            const voiceSelect = document.getElementById('voiceSelect');
            if (!voiceSelect) return;

            // 清除现有选项（除了默认选项）
            while (voiceSelect.options.length > 1) {
                voiceSelect.remove(1);
            }

            const voices = speechSynthesis.getVoices() || [];

            // 只显示中文发音人
            const zhVoices = voices.filter(v => /zh/i.test(v.lang));

            zhVoices.forEach(voice => {
                const option = document.createElement('option');
                option.value = voice.name;
                option.textContent = `${voice.name} (${voice.lang})`;
                voiceSelect.appendChild(option);
            });

            // 恢复已保存的发音人（如果有）
            const saved = localStorage.getItem('selectedVoiceZh');
            if (saved) {
                const found = Array.from(voiceSelect.options).find(o => o.value === saved);
                if (found) voiceSelect.value = saved;
            }
        }

        // 测试发音：按所选发音人、速率、音调播放示例（中文）
        function testVoice() {
            const sample = "这是一次语音测试。";
            const ut = new SpeechSynthesisUtterance(sample);
            ut.lang = 'zh-CN';

            const rateEl = document.getElementById('speechRateSlider');
            const pitchEl = document.getElementById('speechPitchSlider');
            if (rateEl) ut.rate = parseFloat(rateEl.value) || 1.0;
            if (pitchEl) ut.pitch = parseFloat(pitchEl.value) || 1.0;

            const savedName = localStorage.getItem('selectedVoiceZh');
            const voiceSelect = document.getElementById('voiceSelect');
            const voices = speechSynthesis.getVoices() || [];

            let v = null;
            if (savedName) v = voices.find(voice => voice.name === savedName);
            if (!v && voiceSelect && voiceSelect.value) v = voices.find(voice => voice.name === voiceSelect.value);
            if (!v) v = voices.find(voice => /zh/i.test(voice.lang));

            if (v) {
                try { ut.voice = v; } catch (e) {}
            }

            speechSynthesis.cancel();
            speechSynthesis.speak(ut);
        }

        // 朗读当前诗词（使用设置的发音人、速率、音调）
        function readCurrentPoem() {
            if (!poemsData[currentBook] || !poemsData[currentBook][currentPoemIndex]) {
                return;
            }

            const poemData = poemsData[currentBook][currentPoemIndex];
            const poemText = poemData.content.join(' ');

            const utterance = new SpeechSynthesisUtterance(poemText);
            utterance.lang = 'zh-CN';

            // 读取并应用速率/音调（优先使用保存的值）
            const savedRate = localStorage.getItem('speechRateZh');
            const savedPitch = localStorage.getItem('speechPitchZh');
            const rateEl = document.getElementById('speechRateSlider');
            const pitchEl = document.getElementById('speechPitchSlider');

            if (savedRate) utterance.rate = parseFloat(savedRate);
            else if (rateEl) utterance.rate = parseFloat(rateEl.value) || 0.9;
            else utterance.rate = 0.9;

            if (savedPitch) utterance.pitch = parseFloat(savedPitch);
            else if (pitchEl) utterance.pitch = parseFloat(pitchEl.value) || 1.0;
            else utterance.pitch = 1.0;

            // 选择发音人：优先使用已选择并保存的名字
            const savedName = localStorage.getItem('selectedVoiceZh');
            const voiceSelect = document.getElementById('voiceSelect');
            const voices = speechSynthesis.getVoices() || [];

            let chosenVoice = null;
            if (savedName) chosenVoice = voices.find(v => v.name === savedName);
            if (!chosenVoice && voiceSelect && voiceSelect.value) chosenVoice = voices.find(v => v.name === voiceSelect.value);
            if (!chosenVoice) chosenVoice = voices.find(v => /zh/i.test(v.lang));

            if (chosenVoice) {
                try { utterance.voice = chosenVoice; } catch (e) { /* ignore */ }
            }

            speechSynthesis.cancel();
            speechSynthesis.speak(utterance);
        }

        // 切换页面
        function switchPage(pageId) {
            switchPageCommon(pageId, navLinks, pages);
        }

        // 显示当前诗词
        function showCurrentPoem() {
            if (!poemsData[currentBook] || !poemsData[currentBook][currentPoemIndex]) {
                return;
            }
            
            const poemData = poemsData[currentBook][currentPoemIndex];
            poemTitleElement.textContent = poemData.title;
            poemAuthorElement.textContent = poemData.author;
            
            // 清空原有内容
            poemContentElement.innerHTML = '';
            
            // 添加诗词内容
            poemData.content.forEach(line => {
                const lineElement = document.createElement('span');
                lineElement.className = 'poem-line';
                lineElement.textContent = line;
                poemContentElement.appendChild(lineElement);
            });
            
            poemTranslationElement.textContent = poemData.translation;
        }

        // 标记为已背诵
        function markAsMemorized() {
            if (!poemsData[currentBook] || !poemsData[currentBook][currentPoemIndex]) {
                return;
            }
            
            const poemTitle = poemsData[currentBook][currentPoemIndex].title;
            masteredPoems[poemTitle] = true;
            learnedPoems[poemTitle] = true;
            saveProgress();
            updateProgress();
            updatePoemList();
            showNextPoem();
        }

        // 标记为未掌握
        function markAsNotMemorized() {
            if (!poemsData[currentBook] || !poemsData[currentBook][currentPoemIndex]) {
                return;
            }
            
            const poemTitle = poemsData[currentBook][currentPoemIndex].title;
            masteredPoems[poemTitle] = false;
            learnedPoems[poemTitle] = true;
            saveProgress();
            updateProgress();
            updatePoemList();
            showNextPoem();
        }

        // 显示下一首诗词
        function showNextPoem() {
            if (!poemsData[currentBook]) {
                return;
            }
            
            currentPoemIndex = (currentPoemIndex + 1) % poemsData[currentBook].length;
            showCurrentPoem();
        }

        // 显示上一首诗词
        function showPrevPoem() {
            if (!poemsData[currentBook]) {
                return;
            }
            
            currentPoemIndex = (currentPoemIndex - 1 + poemsData[currentBook].length) % poemsData[currentBook].length;
            showCurrentPoem();
        }

        // 处理诗词本变更
        function handleBookChange() {
            currentBook = bookSelectorElement.value;
            currentPoemIndex = 0;
            showCurrentPoem();
            updateProgress();
            updatePoemList();
        }

        // 更新进度显示
        function updateProgress() {
            if (!poemsData[currentBook]) {
                return;
            }
            
            const totalPoems = poemsData[currentBook].length;
            const learned = Object.keys(learnedPoems).filter(title => 
                poemsData[currentBook].some(p => p.title === title)
            ).length;
            const mastered = Object.keys(masteredPoems).filter(title => 
                masteredPoems[title] && poemsData[currentBook].some(p => p.title === title)
            ).length;
            
            totalCountElement.textContent = totalPoems;
            learnedCountElement.textContent = learned;
            masteredCountElement.textContent = mastered;
            
            const progress = totalPoems > 0 ? (learned / totalPoems) * 100 : 0;
            progressFillElement.style.width = `${progress}%`;
            progressPercentageElement.textContent = `${Math.round(progress)}%`;
        }

        // 更新诗词列表显示
        function updatePoemList() {
            if (!poemsData[currentBook]) {
                poemListElement.innerHTML = '<div class="error-message">暂无诗词数据</div>';
                return;
            }
            
            poemListElement.innerHTML = '';
            
            poemsData[currentBook].forEach((poem, index) => {
                const poemItem = document.createElement('div');
                poemItem.className = 'poem-item';
                
                if (masteredPoems[poem.title]) {
                    poemItem.classList.add('mastered');
                }
                
                poemItem.innerHTML = `
                    <div>
                        <div class="poem-name">${poem.title}</div>
                        <div class="poem-author">${poem.author.replace('【', '').replace('】', '')}</div>
                    </div>
                    <div class="poem-item-status">
                        <div class="status-badge">${masteredPoems[poem.title] ? '已背诵' : (learnedPoems[poem.title] ? '学习中' : '未学习')}</div>
                    </div>
                `;
                
                poemItem.addEventListener('click', () => {
                    currentPoemIndex = index;
                    showCurrentPoem();
                });
                
                poemListElement.appendChild(poemItem);
            });
        }

        // 保存进度到本地存储
        function saveProgress() {
            localStorage.setItem('learnedPoems', JSON.stringify(learnedPoems));
            localStorage.setItem('masteredPoems', JSON.stringify(masteredPoems));
        }

        // 从本地存储加载进度
        function loadProgress() {
            const learned = localStorage.getItem('learnedPoems');
            const mastered = localStorage.getItem('masteredPoems');
            
            if (learned) {
                learnedPoems = JSON.parse(learned);
            }
            
            if (mastered) {
                masteredPoems = JSON.parse(mastered);
            }
        }

        // 初始化应用
        window.addEventListener('DOMContentLoaded', init);

        // 确保 voiceschanged 时也填充中文发音列表（voices 可能异步加载）
        if (speechSynthesis.onvoiceschanged !== undefined) {
            speechSynthesis.onvoiceschanged = populateVoiceList;
        }
    </script>
</body>
</html>
